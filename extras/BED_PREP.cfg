#####################################
#          Bed Preparation          #
#      Version 1.0  2023-2-12       #
#####################################

# This macro performs homing, z_tilt,
#  and meshing for a docking probe.

################################
########### BED_PREP ###########
################################
[gcode_macro BED_PREP]
variable_output: 118
gcode:
    {% if params.TARGET is defined %}
        {% set TARGET = params.TARGET|default(100)|float %}
        M{output} {"Heating bed to %f.1" % TARGET}
        SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={TARGET}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={TARGET} MAXIMUM={TARGET+1}
    {% endif %}
    M{output} Homing Z
    G28 Z PROBE_LOCK ; home Z axis
    M{output} Calibrating Z
    STATUS_CALIBRATING_Z
    Z_TILT_ADJUST ; adjust z-tilt
    M{output} Meshing print area
    BED_MESH_CALIBRATE
    M{output} Docking Probe
    Dock_Probe_Unlock ; dock probe
    M{output} Ready