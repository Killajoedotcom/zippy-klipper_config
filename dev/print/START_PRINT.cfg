#####################################
#         Start Print Macro         #
#       Version 2.0  2023-1-4       #
#####################################

################################
##### Start Configuration ######
################################
[gcode_macro _startcfg]
# The following variables define the behavior of macros in this file:
variable_extruder_temp: 220
variable_bed_temp: 220
variable_output: 118                    # Select 116, 117, or 118 to specify output method for feedback
variable_led_status: False              # Use LED Status macros such as on the stealthburner
variable_audio_status: False            # Use audio feedback macros
variable_start_audio: 'PRINT_START_TUNE'
variable_use_telegram: False            # Use Telegram feedback macros
gcode:

################################
######### START_PRINT ##########
################################
[gcode_macro START_PRINT]
gcode:

    # Turn on Smart Filament Sensor
    ENABLEFILAMENTSENSOR

    # Begin preheating and prepping for print
    G90 ; use absolute coordinates
    M83 ; extruder relative mode

    M{output} Preheating bed
    STATUS_HEATING

    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150 ; allow partial nozzle warmup
    #G4 S10 
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP-1} MAXIMUM={BED_TEMP+5}

    M{output} Collecting Probe...
    STATUS_HOMING
    {% if printer.toolhead.homed_axes != "xyz" %}
        M{output} Homing XY...
        G28 Y X ; home XY axis
    {% endif %}
    Attach_Probe_Lock ; attach probe
    M{output} Homing Z...
    G28 Z ; home Z axis
    M{output} Calibrate Z
    STATUS_CALIBRATING_Z
    Z_TILT_ADJUST ; adjust z-tilt
    M{output} Mesh print area
    #BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX}
    BED_MESH_CALIBRATE
    M{output} Docking Probe...
    Dock_Probe_Unlock ; dock probe
    M{output} Preheating tool
    STATUS_HEATING
    M104 S{EXTRUDER_TEMP} ; set final nozzle temp

    G1 Z{25 + printer["gcode_macro CLEAN_NOZZLE"].start_z} F240
    G1 X{printer["gcode_macro CLEAN_NOZZLE"].start_z} Y{printer["gcode_macro CLEAN_NOZZLE"].start_y} F3000 ; move to park position

    #M190 S{BED_TEMP} ; wait for bed temp to stabilize
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP-1} MAXIMUM={BED_TEMP+5}
    M109 S{EXTRUDER_TEMP} ; wait for nozzle temp to stabilize

    PRINT_START_TUNE ; audio feedback

    {% if WIPE == 1 %}
        STATUS_CLEANING
        WIPE_LINE ; Draw wipe line
    {% endif %}

    STATUS_CLEANING
    CLEAN_NOZZLE HOT=True
    ADAPTIVE_PURGE

    M{output} Print Started


################################
########### Aliases ############
################################
[gcode_macro PREP_PRINT]
gcode:
    START_PRINT { rawparams }

[gcode_macro PRINT_START]
gcode:
    START_PRINT { rawparams }